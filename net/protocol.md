# 互联网协议

### OSI标准模型
* 应用层
* 表示层
* 会话层
* 传输层
* 网络层
* 数据链路层
* 物理层

### 五层体系结构模型
* 应用层
* 传输层
* 网络层
* 链接层
* 实体层

#### 实体层
把电脑连接起来的物理手段。规定了网络的一些电器特性，负责传送0和1的电信号。
#### 链接层
规定0和1的分组方式。   
一组电信号构成一个数据包，叫做"帧"。每一帧分成两个部分：标头（Head）和数据（Data）。    
数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做**`MAC地址`**。  
**`广播`**：以太网不是把数据包准确送到接收方，而是向本网络内所有计算机发送，让每台计算机自己判断，是否为接收方。（同一子网络下）
#### 网络层
数据包在不同子网络下采用“路由”方式发送。
网络地址帮助我们确定计算机所在的子网络，MAC地址则将数据包送到该子网络中的目标网卡。  
**`IP地址`**分成两个部分，前一部分代表网络，后一部分代表主机。处于同一子网络下的电脑，它们IP地址的网络部分必定是相同的。  
**`子网掩码`**可以判断任意两个IP地址是否处在同一个子网络。子网掩码的网络部分全部为1，主机部分全部为0。  
**`ARP协议`**：根据IP地址得到同一个子网络内的主机MAC地址。  
如果两台主机不在同一个子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的"网关"（gateway），让网关去处理。  
#### 传输层
"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，我们就能实现程序之间的交流。  
Unix系统把主机+端口，叫做"套接字"（socket）。  
`UDP协议` （用户数据报协议）   
`TCP协议` （传输控制协议）
#### 应用层
"应用层"的作用，就是规定应用程序的数据格式。    
`FTP协议`（文件传输协议）  
`DNS协议`（域名系统）  
`HTTP协议`（超文本传输协议）

##### 小结
* 数据包结构：以太网标头-IP标头-TCP标头-应用层数据包  
* 发送数据包之前，电脑必须判断对方是否在同一个子网络，然后选择相应的MAC地址。  

 场景 	 | 数据包地址 
-----  | ------
同一个子网络 	 |	对方的MAC地址，对方的IP地址
非同一个子网络  |  网关的MAC地址，对方的IP地址

* **`DHCP协议`**（应用层协议）：  
	每一个子网络中，有一台计算机负责管理本网络的所有IP地址，它叫做"DHCP服务器"。新的计算机加入网络，必须向"DHCP服务器"发送一个"DHCP请求"数据包，申请IP地址和相关的网络参数。
* **`DNS协议`**：  
	将网址转换成IP地址。
* DNS到服务器的大致过程：
	1. 客户端对本地DNS请求www.google.com。
	2. 本地DNS服务器向根域名服务器请求解析。
	3. 根域告诉本地DNS，.com域名服务器负责解析。
	4. 本地DNS向.com请求解析。
	5. .com域名服务器告诉本地DNS，.google.com负责解析。
	6. 本地DNS向.google.com发起请求解析。
	7. .google.com域名服务器返回正确IP地址给本地DNS。
	8. 本地DNS将IP返回给客户端。（本地DNS如果有缓存，直接返回IP；同时，缓存接收到的IP。
* TCP三次握手
	1. 第一次握手：客户端发送带有SYN标志的连接请求报文段，然后进入SYN_SENT状态，等待服务端的确认。
	2. 第二次握手：服务端接收到客户端的SYN报文段后，需要发送ACK信息对这个SYN报文段进行确认。同时，还要发送自己的SYN请求信息。服务端会将上述的信息放到一个报文段（SYN+ACK报文段）中，一并发送给客户端，此时服务端将会进入SYN_RCVD状态。
	3. 第三次握手：客户端接收到服务端的SYN+ACK报文段后，会向服务端发送ACK确认报文段，这个报文段发送完毕后，客户端和服务端都进入ESTABLISHED状态，完成TCP三次握手。
	
	> 当三次握手完成后，TCP协议会为连接双方维持连接状态。为了保证数据传输成功，接收端在接收到数据包后必须发送ACK报文作为确认。如果在指定的时间内（这个时间称为重新发送超时时间），发送端没有接收到接收端的ACK报文，那么就会重发超时的数据。
	
	![](https://raw.githubusercontent.com/zhanglei12345/job/master/net/img/net2.jpg)
	![](https://raw.githubusercontent.com/zhanglei12345/job/master/net/img/net3.jpg)
	
* **TCP和UDP的区别**：
	1. TCP面向连接（如打电话要先拨号建立连接）;UDP是无连接的，即发送数据之前不需要建立连接；
	2. TCP提供可靠的通信服务。也就是说，通过TCP连接传送的数据，无差错，不丢失，不重复，且按序到达;UDP则是不可靠信道，尽最大努力交付，即不保证可靠交付；
	3. TCP面向字节流，实际上是TCP把数据看成一连串无结构的字节流;UDP是面向报文的；
	4. TCP具有拥塞控制，UDP没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如IP电话，实时视频会议等）；
	5. 每一条TCP连接只能是点到点的;UDP支持一对一，一对多，多对一和多对多的交互通信；

* 路由器：工作在网络层，是能够连接不同的广域网形成更大的广域网。连接的是异构网络。根据IP地址转发。
* 交换机：工作在数据链路层，是将以太网连接形成更大的以太网，同一个网络。根据MAC地址进行转发。
* **TCP状态转换图**：
![](https://raw.githubusercontent.com/zhanglei12345/job/master/net/img/net1.jpg)


##### 参考链接：
[阮一峰网络日志-互联网协议入门一](http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html)  
[阮一峰网络日志-互联网协议入门二](http://www.ruanyifeng.com/blog/2012/06/internet_protocol_suite_part_ii.html)
